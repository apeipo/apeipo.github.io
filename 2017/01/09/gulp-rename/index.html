<!DOCTYPE html><html><head><meta charset="utf-8"><title>gulp重命名和替换js文件 | linxianlong的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Javascript,"><meta name="description" content="内部开发的平台出现问题，服务端修改了JS文件，但因为用户浏览器有缓存，导致使用时出现问题，有时候强刷也没有用。而页面引用的js文件比较多，也不能全文件都不缓存。比较常用的解决方案是：在开发环境修改js文件src.js开发完成后根据文件的md5生成src-{md5}.js开发完成后发布到生产环境，将页面模板中的js链接替换成src-{md5}.js使用gulp可以很简单的实现上诉步骤。安装gulp相"><meta name="keywords" content="Javascript"><meta property="og:type" content="article"><meta property="og:title" content="gulp重命名和替换js文件"><meta property="og:url" content="http://longlog.me/2017/01/09/gulp-rename/index.html"><meta property="og:site_name" content="linxianlong的博客"><meta property="og:description" content="内部开发的平台出现问题，服务端修改了JS文件，但因为用户浏览器有缓存，导致使用时出现问题，有时候强刷也没有用。而页面引用的js文件比较多，也不能全文件都不缓存。比较常用的解决方案是：在开发环境修改js文件src.js开发完成后根据文件的md5生成src-{md5}.js开发完成后发布到生产环境，将页面模板中的js链接替换成src-{md5}.js使用gulp可以很简单的实现上诉步骤。安装gulp相"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2019-08-29T07:09:16.052Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="gulp重命名和替换js文件"><meta name="twitter:description" content="内部开发的平台出现问题，服务端修改了JS文件，但因为用户浏览器有缓存，导致使用时出现问题，有时候强刷也没有用。而页面引用的js文件比较多，也不能全文件都不缓存。比较常用的解决方案是：在开发环境修改js文件src.js开发完成后根据文件的md5生成src-{md5}.js开发完成后发布到生产环境，将页面模板中的js链接替换成src-{md5}.js使用gulp可以很简单的实现上诉步骤。安装gulp相"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装gulp相关插件"><span class="toc-text">安装gulp相关插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在根目录下新建gulp脚本gulpfile-js"><span class="toc-text">在根目录下新建gulp脚本gulpfile.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意事项："><span class="toc-text">注意事项：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-gulp的任务执行顺序"><span class="toc-text">1.gulp的任务执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-文件路径的替换"><span class="toc-text">2.文件路径的替换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他常用的gulp插件"><span class="toc-text">其他常用的gulp插件</span></a></li></ol></div><div class="content-post LEFT"><article id="post-gulp-rename" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">gulp重命名和替换js文件</h1><div class="article-meta"><span>2017-01-09</span> <span>| </span><span class="article-author">Linxianlong</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/前端/">前端</a></span></div></header><div class="article-content"><p>内部开发的平台出现问题，服务端修改了JS文件，但因为用户浏览器有缓存，导致使用时出现问题，有时候强刷也没有用。而页面引用的js文件比较多，也不能全文件都不缓存。<br>比较常用的解决方案是：</p><blockquote><ol><li>在开发环境修改js文件src.js</li><li>开发完成后根据文件的md5生成src-{md5}.js</li><li>开发完成后发布到生产环境，将页面模板中的js链接替换成src-{md5}.js</li></ol></blockquote><p>使用gulp可以很简单的实现上诉步骤。</p><h2 id="安装gulp相关插件"><a href="#安装gulp相关插件" class="headerlink" title="安装gulp相关插件"></a>安装gulp相关插件</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装gulp</span></span><br><span class="line">npm install gulp </span><br><span class="line"></span><br><span class="line"><span class="comment">#生成m5d命名文件的插件</span></span><br><span class="line">npm install gulp-rev</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换页面引用url的插件</span></span><br><span class="line">npm install gulp-rev-collector</span><br></pre></td></tr></table></figure><h2 id="在根目录下新建gulp脚本gulpfile-js"><a href="#在根目录下新建gulp脚本gulpfile-js" class="headerlink" title="在根目录下新建gulp脚本gulpfile.js"></a>在根目录下新建gulp脚本gulpfile.js</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp         = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</span><br><span class="line"><span class="keyword">var</span> rev          = <span class="built_in">require</span>(<span class="string">'gulp-rev'</span>);<span class="comment">//生成md5命名文件</span></span><br><span class="line"><span class="keyword">var</span> revCollector = <span class="built_in">require</span>(<span class="string">'gulp-rev-collector'</span>);<span class="comment">//替换页面引用链接</span></span><br><span class="line">gulp.task(<span class="string">'jsrename'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> gulp.src(</span><br><span class="line">		<span class="comment">//需要重命名的文件列表</span></span><br><span class="line">	    [</span><br><span class="line">		<span class="string">"./public/js/show-create.js"</span>, </span><br><span class="line">		<span class="string">"./public/js/base.js"</span>,  </span><br><span class="line">		<span class="string">"./public/js/main.js"</span>,</span><br><span class="line">		<span class="string">"./public/css/strategy-solution.css"</span>,</span><br><span class="line">		<span class="string">"./public/css/style.css"</span>,</span><br><span class="line">		], </span><br><span class="line">		&#123;<span class="attr">base</span> : <span class="string">"public"</span>&#125;)	               <span class="comment">//基础目录，保留源文件相对这个目录的路径</span></span><br><span class="line">	  .pipe(rev())	                     <span class="comment">//文件重命名</span></span><br><span class="line">	  .pipe(gulp.dest(<span class="string">"./public/dist"</span>))  <span class="comment">//重命名文件保存的目录</span></span><br><span class="line">	  .pipe(rev.manifest())				<span class="comment">//生成转换列表的json文件</span></span><br><span class="line">	  .pipe(gulp.dest(<span class="string">"./public"</span>));		<span class="comment">//json文件保存目录</span></span><br><span class="line">	</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二个参数表示task需要依赖指定task执行完成后执行</span></span><br><span class="line">gulp.task(<span class="string">'rev'</span>, [<span class="string">'jsrename'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> gulp.src(</span><br><span class="line">			[</span><br><span class="line">			 <span class="string">'./public/*.json'</span>,                  <span class="comment">//rev-manifest.json的路径</span></span><br><span class="line">			 <span class="string">'./resources/views/**/*.blade.php'</span>, <span class="comment">//需要替换链接的文件</span></span><br><span class="line">			])</span><br><span class="line">			<span class="comment">//读取 rev-manifest.json 文件以及需要进行css名替换的文件</span></span><br><span class="line">			.pipe(revCollector(&#123;</span><br><span class="line">				replaceReved: <span class="literal">true</span>,</span><br><span class="line">				dirReplacements : &#123;</span><br><span class="line">					<span class="string">'/'</span>: <span class="string">'/dist'</span>,	<span class="comment">//路径替换配置</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;))</span><br><span class="line">			.pipe(gulp.dest(<span class="string">'./resources/dist_view'</span>));	<span class="comment">//替换后的文件输出的目录</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'default'</span>, [<span class="string">'jsrename'</span>, <span class="string">'rev'</span>]);<span class="comment">//执行任务</span></span><br></pre></td></tr></table></figure><p>执行gulp后在public目录下生成<strong>rev-manifest.json</strong>文件:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"css/strategy-solution.css"</span>: <span class="string">"css/strategy-solution-c51ee853ba.css"</span>,</span><br><span class="line">  <span class="attr">"css/style.css"</span>: <span class="string">"css/style-551a462e31.css"</span>,</span><br><span class="line">  <span class="attr">"js/base.js"</span>: <span class="string">"js/base-f4a7b9200a.js"</span>,</span><br><span class="line">  <span class="attr">"js/main.js"</span>: <span class="string">"js/main-05828bf4dc.js"</span>,</span><br><span class="line">  <span class="attr">"js/show-create.js"</span>: <span class="string">"js/show-create-10239cd469.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码目录生成的文件列表如下：</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">public/dist/</span><br><span class="line">├── css</span><br><span class="line">│   ├── strategy-solution-c51ee853ba.css</span><br><span class="line">│   └── style-551a462e31.css</span><br><span class="line">└── js</span><br><span class="line">    ├── base-f4a7b9200a.js</span><br><span class="line">    ├── main-05828bf4dc.js</span><br><span class="line">    └── show-create-10239cd469.js</span><br></pre></td></tr></table></figure><p>页面代码中的JS链接替换如下，只会替换脚本中列表的文件：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/dist/js/show-create-10239cd469.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h2><h3 id="1-gulp的任务执行顺序"><a href="#1-gulp的任务执行顺序" class="headerlink" title="1.gulp的任务执行顺序"></a>1.gulp的任务执行顺序</h3><p>修改了js文件，执行gulp后发现，<code>rev-manifest.json</code>生成了，但是页面中替换的结果还是上一次的。<br>这个问题是因为<strong>gulp的task执行是异步的</strong>，在执行rev这个任务时，jsrename这个任务还没完成，还没有更新json文件，导致rev任务执行完成后结果没有变化。<br>解决方案就是加入<strong>rev任务对jsrename的依赖</strong>（gulp.task方法的第二个参数），这样这两个任务就会顺序执行。</p><h3 id="2-文件路径的替换"><a href="#2-文件路径的替换" class="headerlink" title="2.文件路径的替换"></a>2.文件路径的替换</h3><p>在renamejs这个task中，因为加了<code>{base : &quot;public&quot;}</code>这个配置，在生成json文件时，文件名都是带着路径的，如<code>js/main.js</code>。<br>此时要注意，如果你页面中的js引用url是<code>/js/main.js</code>，而你要替换成<code>/dist/js/main.sh</code>。在revCollector中dirReplacements应该配置成<code>&#39;/&#39;: &#39;/dist&#39;,</code>(如上gulpfile.js)。这里猜测是因为revCollector中将json中的key整体作为文件名，页面中应用的src去掉这部分文件名后其余部分作为路径。</p><h2 id="其他常用的gulp插件"><a href="#其他常用的gulp插件" class="headerlink" title="其他常用的gulp插件"></a>其他常用的gulp插件</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">"gulp-concat"</span>       <span class="comment">//文件合并</span></span><br><span class="line"><span class="string">"gulp-jshint"</span>,      <span class="comment">//js文件检查  </span></span><br><span class="line"><span class="string">"gulp-minify-css"</span>,  <span class="comment">//css文件压缩</span></span><br><span class="line"><span class="string">"gulp-uglify"</span>,      <span class="comment">//js文件压缩</span></span><br><span class="line"><span class="string">"gulp-imagemin"</span>,    <span class="comment">//图片压缩</span></span><br><span class="line"><span class="string">"gulp-rename"</span>,      <span class="comment">//文件重命名</span></span><br></pre></td></tr></table></figure></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2017/01/09/gulp-rename/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>