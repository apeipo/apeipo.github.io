<!DOCTYPE html><html><head><meta charset="utf-8"><title>Twemproxy + SSDB 性能测试 | linxianlong的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="SSDB,Twemproxy,"><meta name="description" content="背景SSDB是一个高性能的NoSql数据库，底层使用LevelDB，兼容Redis协议。主要用于解决Redis无法存储海量数据的问题。官网链接Twemproxy 是twitter开源的高性能、轻量级redis集群代理问题如下图，线上ssdb集群的耗时随着时间的增长耗时不断增长，最高时达到6.5s场景线上部署采用的是twemproxy + ssdb的方式。2台proxy下挂4台ssdb服务请求方为4"><meta name="keywords" content="SSDB,Twemproxy"><meta property="og:type" content="article"><meta property="og:title" content="Twemproxy + SSDB 性能测试"><meta property="og:url" content="http://longlog.me/2017/04/06/twemprxy-ssdb-performance/index.html"><meta property="og:site_name" content="linxianlong的博客"><meta property="og:description" content="背景SSDB是一个高性能的NoSql数据库，底层使用LevelDB，兼容Redis协议。主要用于解决Redis无法存储海量数据的问题。官网链接Twemproxy 是twitter开源的高性能、轻量级redis集群代理问题如下图，线上ssdb集群的耗时随着时间的增长耗时不断增长，最高时达到6.5s场景线上部署采用的是twemproxy + ssdb的方式。2台proxy下挂4台ssdb服务请求方为4"><meta property="og:locale" content="default"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914576091140.jpg"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914492594626.jpg"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914517106043.jpg"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914518753097.jpg"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914521918853.jpg"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914520378195.jpg"><meta property="og:updated_time" content="2018-08-06T12:12:41.827Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Twemproxy + SSDB 性能测试"><meta name="twitter:description" content="背景SSDB是一个高性能的NoSql数据库，底层使用LevelDB，兼容Redis协议。主要用于解决Redis无法存储海量数据的问题。官网链接Twemproxy 是twitter开源的高性能、轻量级redis集群代理问题如下图，线上ssdb集群的耗时随着时间的增长耗时不断增长，最高时达到6.5s场景线上部署采用的是twemproxy + ssdb的方式。2台proxy下挂4台ssdb服务请求方为4"><meta name="twitter:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914576091140.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#场景"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题推测"><span class="toc-text">问题推测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy-性能测试"><span class="toc-text">Proxy 性能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxy测试场景和结果"><span class="toc-text">Proxy测试场景和结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#server-connection"><span class="toc-text">server_connection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mbuf"><span class="toc-text">mbuf</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#效果"><span class="toc-text">效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他测试"><span class="toc-text">其他测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis替换SSDB能否提升性能"><span class="toc-text">Redis替换SSDB能否提升性能?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用get-set能否提升性能"><span class="toc-text">使用get/set能否提升性能?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxy的数量多少合适？"><span class="toc-text">Proxy的数量多少合适？</span></a></li></ol></li></ol></div><div class="content-post LEFT"><article id="post-twemprxy-ssdb-performance" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">Twemproxy + SSDB 性能测试</h1><div class="article-meta"><span>2017-04-06</span> <span>| </span><span class="article-author">Linxianlong</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/后端/">后端</a></span></div></header><div class="article-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ol><li>SSDB是一个高性能的NoSql数据库，底层使用LevelDB，兼容Redis协议。主要用于解决Redis无法存储海量数据的问题。<a href="http://ssdb.io/zh_cn/" target="_blank" rel="noopener">官网链接</a></li><li>Twemproxy 是twitter开源的高性能、轻量级redis集群代理</li></ol><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>如下图，线上ssdb集群的耗时随着时间的增长耗时不断增长，最高时达到6.5s<br><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914576091140.jpg" alt=""></p><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ol><li>线上部署采用的是twemproxy + ssdb的方式。2台proxy下挂4台ssdb</li><li>服务请求方为4台机器，每台机器50个线程，每个线程单次读取1000条数据（hget请求）</li><li>twemproxy和ssdb均采用官方推荐配置，ssdb开启缓存为20G</li><li><strong>客户端连接proxy使用的是jedis客户端，使用pipline方式进行批量请求</strong>。</li></ol><p>可以推算出：<br>最高QPS： <code>4 * 50 * 1000 = 20w</code><br>SSDB单机最高QPS： 5w<br>PROXY单机最高QPS：10w<br>上图中6.5s耗时为单个线程请求三份数据的总耗时（串行），每份数据为1000条，因此可以推算出单<strong>次请求1000条数据的耗时在2s上下</strong>，无法满足要求。</p><h3 id="问题推测"><a href="#问题推测" class="headerlink" title="问题推测"></a>问题推测</h3><ol><li>除了ssdb耗时高以外， 服务请求方机器内存、CPU、IO、网络均正常，并且重启客户端耗时无变化，可以排除是客户端的问题。</li><li>SSDB机器和Proxy机器的内存、CPU、IO、网络均正常，可以排除是系统层面的问题</li><li>客户端请求读取的都是半小时内刚写入的数据，可以排除是读取请求都落在磁盘上导致的性能下降</li></ol><p>因此，问题原因基本可以判定是出现在Proxy或者SSDB自身上，测试也主要针对这两个部分分别进行。</p><h2 id="Proxy-性能测试"><a href="#Proxy-性能测试" class="headerlink" title="Proxy 性能测试"></a>Proxy 性能测试</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ol><li>测试环境使用单台proxy下挂2台ssdb（相当于线上一半的配置）</li><li>SSDB数据量分别为107G和117G。</li><li>客户端连接使用jedis的pipeline批量请求</li></ol><h3 id="Proxy测试场景和结果"><a href="#Proxy测试场景和结果" class="headerlink" title="Proxy测试场景和结果"></a>Proxy测试场景和结果</h3><p><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914492594626.jpg" alt=""></p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ol><li>提高server_connection对性能的影响明显，在线下环境下，设置为15<strong>提升约1倍的性能</strong>（对比场景11和场景9）</li><li>修改启动的-m选项，<strong>提升性能约10%</strong>（对比场景13和12）</li></ol><p>关于server_connection和mbuf的官方说明：<a href="https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md" target="_blank" rel="noopener">twemproxy文档</a></p><h4 id="server-connection"><a href="#server-connection" class="headerlink" title="server_connection"></a>server_connection</h4><ol><li>Twemproxy与SSDB客户端之间的保持的连接数。<strong>默认为1</strong>，即Proxy和SSDB实例之间只使用一个连接。</li><li>Twemproxy对该连接的使用是基于epool事件循环，因此该连接能支持很高的并发。</li></ol><p>提高server_connection对性能影响很大，猜测是当前的并发已经达到了单个连接的上限。不过继续当达到一定数量后提高server_connection对性能的不大（对比场景14和13），甚至有可能下降，这个原因没有细查，猜测可能是连接数大了后Proxy的维护和切换成本会提高。</p><h4 id="mbuf"><a href="#mbuf" class="headerlink" title="mbuf"></a>mbuf</h4><p>Twemproxy存储request数据使用的最小单位，默认为16M。当并发高时，官方建议调小该值，否则很可能造成很高的内存占用。</p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>在线上修改了server_connection和mbuf参数后，耗时下降明显，接近ssdb的极限性能。</p><p><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914517106043.jpg" alt=""></p><h2 id="其他测试"><a href="#其他测试" class="headerlink" title="其他测试"></a>其他测试</h2><h3 id="Redis替换SSDB能否提升性能"><a href="#Redis替换SSDB能否提升性能" class="headerlink" title="Redis替换SSDB能否提升性能?"></a>Redis替换SSDB能否提升性能?</h3><p>可以看出，redis对ssdb的性能提升不明显。原因是测试中读取的都是热数据，ssdb的读取都是内存操作，和redis读取的差别不大。<br><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914518753097.jpg" alt=""></p><h3 id="使用get-set能否提升性能"><a href="#使用get-set能否提升性能" class="headerlink" title="使用get/set能否提升性能?"></a>使用get/set能否提升性能?</h3><p>将存储数据进行转换，测试脚本中的hget操作修改为get操作，get的性能相比hget提升约1/3。<br>但是改为get后，实际的请求量会增长（如果hash结构中有4个key，则改为get后请求增长4倍），因此修改为get请求对整体并没有帮助。<br><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914521918853.jpg" alt=""></p><h3 id="Proxy的数量多少合适？"><a href="#Proxy的数量多少合适？" class="headerlink" title="Proxy的数量多少合适？"></a>Proxy的数量多少合适？</h3><p>从结果数据来看：</p><ol><li>proxy和ssdb数量达到2：1后，再增加proxy对性能已经基本没有提升（此时实际上已经到了ssdb的性能上限）。</li><li>proxy和ssdb数量2：1相对于1：1的性能提升约为15%</li></ol><p>所以，2：1的话能使性能最大化，但是比较浪费资源，1：1是合理的方案。<br>实际线上部署时，一台机器可以部署2~4个proxy，线下在单台机器部署3个proxy时，在100并发每次2000数据的情况下，影响CPU-IDLE约5，网卡占用约15%。<br><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2017-04-06-14914520378195.jpg" alt=""></p></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2017/04/06/twemprxy-ssdb-performance/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>