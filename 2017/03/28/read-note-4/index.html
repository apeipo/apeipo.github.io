<!DOCTYPE html><html><head><meta charset="utf-8"><title>博文阅读笔记 - 三月 | linxianlong的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="NOTE,"><meta name="description" content="2017-3-28 新浪微博升级PHP7实践原文链接：新浪微博升级PHP7原生的PHP，Zend引擎将php代码编译成opcode，再解释执行（执行C语言级的函数）。HHVM替代了sZend引擎，PHP代码编译成字节码后，直接解释成机器的机器码执行。代码升级一些Fatal可以通过catch Error进行捕获。被0除，PHP7之前会产生WARNING并返回false，PHP7会返回+INF（正无穷"><meta name="keywords" content="NOTE"><meta property="og:type" content="article"><meta property="og:title" content="博文阅读笔记 - 三月"><meta property="og:url" content="http://longlog.me/2017/03/28/read-note-4/index.html"><meta property="og:site_name" content="linxianlong的博客"><meta property="og:description" content="2017-3-28 新浪微博升级PHP7实践原文链接：新浪微博升级PHP7原生的PHP，Zend引擎将php代码编译成opcode，再解释执行（执行C语言级的函数）。HHVM替代了sZend引擎，PHP代码编译成字节码后，直接解释成机器的机器码执行。代码升级一些Fatal可以通过catch Error进行捕获。被0除，PHP7之前会产生WARNING并返回false，PHP7会返回+INF（正无穷"><meta property="og:locale" content="default"><meta property="og:image" content="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2017-03-28-14906944807555.jpg"><meta property="og:image" content="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2017-03-28-14906967611663.jpg"><meta property="og:updated_time" content="2019-08-29T07:09:16.059Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="博文阅读笔记 - 三月"><meta name="twitter:description" content="2017-3-28 新浪微博升级PHP7实践原文链接：新浪微博升级PHP7原生的PHP，Zend引擎将php代码编译成opcode，再解释执行（执行C语言级的函数）。HHVM替代了sZend引擎，PHP代码编译成字节码后，直接解释成机器的机器码执行。代码升级一些Fatal可以通过catch Error进行捕获。被0除，PHP7之前会产生WARNING并返回false，PHP7会返回+INF（正无穷"><meta name="twitter:image" content="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2017-03-28-14906944807555.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#2017-3-28-新浪微博升级PHP7实践"><span class="toc-text">2017-3-28 新浪微博升级PHP7实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码升级"><span class="toc-text">代码升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化措施"><span class="toc-text">优化措施</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2017-3-28-Redis架构之防雪崩设计"><span class="toc-text">2017-3-28 Redis架构之防雪崩设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存穿透"><span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#雪崩"><span class="toc-text">雪崩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热点Key优化"><span class="toc-text">热点Key优化</span></a></li></ol></li></ol></div><div class="content-post LEFT"><article id="post-read-note-4" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">博文阅读笔记 - 三月</h1><div class="article-meta"><span>2017-03-28</span> <span>| </span><span class="article-author">Linxianlong</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/NOTE/">NOTE</a></span></div></header><div class="article-content"><h2 id="2017-3-28-新浪微博升级PHP7实践"><a href="#2017-3-28-新浪微博升级PHP7实践" class="headerlink" title="2017-3-28 新浪微博升级PHP7实践"></a>2017-3-28 新浪微博升级PHP7实践</h2><p>原文链接：<a href="http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650994868&amp;idx=1&amp;sn=c79e0217ce2b3454c654fa9d90212d09&amp;chksm=bdbf00e78ac889f11e65c4cbbcb9ea903b65422da93e61936e7badc828aa98d9df5460a0f3d7&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">新浪微博升级PHP7</a><br>原生的PHP，Zend引擎将php代码编译成opcode，再解释执行（执行C语言级的函数）。<br>HHVM替代了sZend引擎，PHP代码编译成字节码后，直接解释成机器的机器码执行。<br><img src="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2017-03-28-14906944807555.jpg" alt=""></p><h3 id="代码升级"><a href="#代码升级" class="headerlink" title="代码升级"></a>代码升级</h3><ol><li>一些Fatal可以通过catch Error进行捕获。</li><li>被0除，PHP7之前会产生WARNING并返回false，PHP7会返回+INF（正无穷），-INF（负无穷），INF（0/0）</li><li>取模0时，PHP7之前产生WARNING，PHP7抛出 DivisionByZeroError 异常</li><li>警告级别变更<br><img src="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2017-03-28-14906967611663.jpg" alt=""></li></ol><p>…其他参考原文</p><h3 id="优化措施"><a href="#优化措施" class="headerlink" title="优化措施"></a>优化措施</h3><ol><li>启用Opcache</li><li>开启hugepage</li></ol><blockquote><p>操作系统默认的内存是以4KB分页的，而虚拟地址和内存地址需要转换， 而这个转换要查表，CPU为了加速这个查表过程会内建TLB(Translation Lookaside Buffer)。 显然，如果虚拟页越小，表里的条目数也就越多，而TLB大小是有限的，条目数越多TLB的Cache Miss也就会越高， 所以如果我们能启用大内存页就能间接降低这个TLB Cache Miss。<br>PHP7开启HugePage支持后，会把自身的text段, 以及内存分配中的huge都采用大内存页来保存, 减少TLB miss, 从而提高性能。相关实现可参考Opcache实现中的</p></blockquote><h2 id="2017-3-28-Redis架构之防雪崩设计"><a href="#2017-3-28-Redis架构之防雪崩设计" class="headerlink" title="2017-3-28 Redis架构之防雪崩设计"></a>2017-3-28 Redis架构之防雪崩设计</h2><p>原文链接：<a href="http://mp.weixin.qq.com/s/TBCEwLVAXdsTszRVpXhVug" target="_blank" rel="noopener">Redis架构之防雪崩设计</a></p><h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>当请求的数据在缓存层和存储层中都不存在时，会发生缓存穿透，请求流量直接打到存储层。缓存穿透时缓存失去对后端的保护作用，容易被攻击者利用。<br>缓存穿透的解决方法：</p><ol><li>缓存空对象<br>当从存储层读不到数据时，在缓存中写入空对象，下次请求时直接返回空对象。<br>这种方案的缺点是如果被攻击，会消耗大量的内存空间（存储空对象），这种情况下，可以给空值缓存的key设置过期时间来缓解。</li><li>布隆过滤器<br>在redis之前加一层保护，定期更新一批存在的key。请求时，如果用布隆过滤器判断key不存在，则直接返回。<br>该方案的缺点是布隆过滤器的数据需要定期更新，在更新周期内可能存在数据不一致的情况。</li></ol><h3 id="雪崩"><a href="#雪崩" class="headerlink" title="雪崩"></a>雪崩</h3><p>当缓存无法提供服务时，所有的请求流量都会到存储层，存储层压力暴增，造成存储层不可用进而影响其他系统。<br>雪崩主要通过服务隔离、服务限流、服务降级、灾备演练等方法避免。</p><h3 id="热点Key优化"><a href="#热点Key优化" class="headerlink" title="热点Key优化"></a>热点Key优化</h3><p>一般缓存的key都存在失效失效时间，当热点key（并发请求量大）失效时，如果重建缓存的过程比较复杂（如多个SQL、多个依赖、逻辑复杂），大量服务器资源用于重建缓存，造成后端负载过大。<br>热点key优化的方法：</p><ol><li>重建缓存过程加锁<br>当某个进程发现key失效时，该进程对该key进行加锁（如setnx）后进入重建逻辑，其他进程请求该key的进程进入等待。<br>这种方法的缺点很明显，有可能造成死锁或者大量进程的等待。</li><li>逻辑上控制失效时间<br>在redis中不设置key的失效时间，业务逻辑上控制失效，当发现key失效时，发起一个异步重建的任务。<br>这种方法的缺点是在重建这段时间存在数据不一致，优点是能大大降低热点key失效时的负载（实际上相当于该key在redis中永远不会失效）。</li></ol></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2017/03/28/read-note-4/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>