<!DOCTYPE html><html><head><meta charset="utf-8"><title>Lumen自定义配置 | linxianlong的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="PHP,LUMEN,LARAVEL,"><meta name="description" content="先从一个问题说起，Lumen在使用Redis时，文档中有一段说明：If you have not called $app-&amp;gt;withEloquent() in your bootstrap/app.php file, then you should call app-&amp;gt;configure(‘database’); in the bootstrap/app.php file to ens"><meta name="keywords" content="PHP,LUMEN,LARAVEL"><meta property="og:type" content="article"><meta property="og:title" content="Lumen自定义配置"><meta property="og:url" content="http://longlog.me/2017/07/06/lumen-config/index.html"><meta property="og:site_name" content="linxianlong的博客"><meta property="og:description" content="先从一个问题说起，Lumen在使用Redis时，文档中有一段说明：If you have not called $app-&amp;gt;withEloquent() in your bootstrap/app.php file, then you should call app-&amp;gt;configure(‘database’); in the bootstrap/app.php file to ens"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2018-08-06T12:12:41.817Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Lumen自定义配置"><meta name="twitter:description" content="先从一个问题说起，Lumen在使用Redis时，文档中有一段说明：If you have not called $app-&amp;gt;withEloquent() in your bootstrap/app.php file, then you should call app-&amp;gt;configure(‘database’); in the bootstrap/app.php file to ens"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis使用的配置"><span class="toc-text">redis使用的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#database-php在什么时候加载？"><span class="toc-text">database.php在什么时候加载？</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#配置加载"><span class="toc-text">配置加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel的配置加载方式"><span class="toc-text">Laravel的配置加载方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lumen的配置加载方式"><span class="toc-text">Lumen的配置加载方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li></div><div class="content-post LEFT"><article id="post-lumen-config" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">Lumen自定义配置</h1><div class="article-meta"><span>2017-07-06</span> <span>| </span><span class="article-author">Linxianlong</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/后端/">后端</a></span></div></header><div class="article-content"><p>先从一个问题说起，Lumen在使用Redis时，文档中有一段说明：</p><blockquote><p>If you have not called $app-&gt;withEloquent() in your bootstrap/app.php file, then you should call app-&gt;configure(‘database’); in the bootstrap/app.php file to ensure the Redis database configuration is properly loaded.</p></blockquote><p>如果没有调用<code>$app-&gt;withEloquent()</code>的话，需要调用<code>$app-&gt;configure(&#39;database&#39;)</code>来加载redis的配置。为什么需要这么做呢？</p><h3 id="redis使用的配置"><a href="#redis使用的配置" class="headerlink" title="redis使用的配置"></a>redis使用的配置</h3><p>Redis使用的配置比较容易查看，在安装<code>illuminate/redis</code>后查看<code>vendor/illuminate/redis/RedisServiceProvider.php</code>，可以看到该Service使用的配置是<code>database.redis</code><br><strong>注意区分CacheService使用的配置，Cache使用的配置是config/cache.php</strong></p><h3 id="database-php在什么时候加载？"><a href="#database-php在什么时候加载？" class="headerlink" title="database.php在什么时候加载？"></a>database.php在什么时候加载？</h3><p>按照文档的说法，需要调用<code>$app-&gt;withEloquent()</code> 或者 <code>$app-&gt;configure(&#39;database&#39;)</code>。<br>withEloquent做了什么？</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#withEloquent调用了make，创建db模块</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withEloquent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;make(<span class="string">'db'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#make是Appliation提供的注册模块实例的方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">#先从this-&gt;alias中获取模块对应的别名</span></span><br><span class="line">	$abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</span><br><span class="line">	<span class="comment">#根据名称在availableBindings中查找对应的注册方法进行初始化</span></span><br><span class="line">	<span class="keyword">if</span> (array_key_exists($abstract, <span class="keyword">$this</span>-&gt;availableBindings) &amp;&amp;</span><br><span class="line">	  ! array_key_exists(<span class="keyword">$this</span>-&gt;availableBindings[$abstract], <span class="keyword">$this</span>-&gt;ranServiceBinders)) &#123;</span><br><span class="line">	  <span class="keyword">$this</span>-&gt;&#123;$method = <span class="keyword">$this</span>-&gt;availableBindings[$abstract]&#125;();</span><br><span class="line">	  <span class="keyword">$this</span>-&gt;ranServiceBinders[$method] = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#availableBindings定义了模块和其对应的初始化方法</span></span><br><span class="line"> <span class="keyword">public</span> $availableBindings = [</span><br><span class="line">	...</span><br><span class="line">   <span class="string">'db'</span> =&gt; <span class="string">'registerDatabaseBindings'</span>,</span><br><span class="line">   <span class="string">'config'</span> =&gt; <span class="string">'registerConfigBindings'</span>,</span><br><span class="line">   ...</span><br><span class="line">];</span><br><span class="line"><span class="comment">#registerDatabaseBindings方法中调用loadComponent初始化db模块，并注册到Application中，</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerDatabaseBindings</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;singleton(<span class="string">'db'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;loadComponent(</span><br><span class="line">           <span class="string">'database'</span>, [</span><br><span class="line">               <span class="string">'Illuminate\Database\DatabaseServiceProvider'</span>,</span><br><span class="line">               <span class="string">'Illuminate\Pagination\PaginationServiceProvider'</span>,</span><br><span class="line">           ], <span class="string">'db'</span></span><br><span class="line">       );</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#loadComponent会调用configure加载配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadComponent</span><span class="params">($config, $providers, $return = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;configure($config);</span><br><span class="line">   <span class="keyword">foreach</span> ((<span class="keyword">array</span>) $providers <span class="keyword">as</span> $provider) &#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;register($provider);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($return ?: $config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以，如果调用了withEloquent，则database就已经被加载进来，不要再用configure注册了。</p><h2 id="配置加载"><a href="#配置加载" class="headerlink" title="配置加载"></a>配置加载</h2><p>再来看Lumen的配置加载方式</p><h3 id="Laravel的配置加载方式"><a href="#Laravel的配置加载方式" class="headerlink" title="Laravel的配置加载方式"></a>Laravel的配置加载方式</h3><p>比较简单，在boostraps中调用LoadConfiguration，扫描config目录下的所有文件，使用Illuminate\Contracts\Config\Repository（Config实际使用的类）保存配置。<br>如果开启了配置cache，则会加载bootstrap/cache/config.php。</p><h3 id="Lumen的配置加载方式"><a href="#Lumen的配置加载方式" class="headerlink" title="Lumen的配置加载方式"></a>Lumen的配置加载方式</h3><p>从上一节可以看到，Lumen的配置加载是按照模块的需要，最终调用configure方法进行加载。configure方法的调用代码如下。<br>从代码中可以看出来，configure会先从<strong>“项目根目录/config”</strong>目录下加载配置，如果不存在则从<strong>“Application.php所在目录/../config”</strong>加载。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置加载方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">configure</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;loadedConfigurations[$name])) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;loadedConfigurations[$name] = <span class="keyword">true</span>;</span><br><span class="line">	  <span class="comment">#获取配置路径</span></span><br><span class="line">   $path = <span class="keyword">$this</span>-&gt;getConfigurationPath($name);</span><br><span class="line">   <span class="keyword">if</span> ($path) &#123;</span><br><span class="line">   		<span class="comment">#生成config模块的实例</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;make(<span class="string">'config'</span>)-&gt;set($name, <span class="keyword">require</span> $path);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#从上一节中的availableBindings数组可以看出，config模块实例初始化方法为registerConfigBindings</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerConfigBindings</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;singleton(<span class="string">'config'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">   		<span class="comment">#Illuminate\Config\Repository as ConfigRepository;</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ConfigRepository;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#配置路径获取方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfigurationPath</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (! $name) &#123;</span><br><span class="line">       $appConfigDir = <span class="keyword">$this</span>-&gt;basePath(<span class="string">'config'</span>).<span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (file_exists($appConfigDir)) &#123;</span><br><span class="line">           <span class="keyword">return</span> $appConfigDir;</span><br><span class="line">       &#125; <span class="keyword">elseif</span> (file_exists($path = <span class="keyword">__DIR__</span>.<span class="string">'/../config/'</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> $path;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       $appConfigPath = <span class="keyword">$this</span>-&gt;basePath(<span class="string">'config'</span>).<span class="string">'/'</span>.$name.<span class="string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (file_exists($appConfigPath)) &#123;</span><br><span class="line">           <span class="keyword">return</span> $appConfigPath;</span><br><span class="line">       &#125; <span class="keyword">elseif</span> (file_exists($path = <span class="keyword">__DIR__</span>.<span class="string">'/../config/'</span>.$name.<span class="string">'.php'</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> $path;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>从Lumen的配置加载可以看出来，<strong>Lumen没有像Laravel那样自动加载config下的所有配置文件</strong>（从这里也可以看出，Lumen按需加载的原则）。因此，如果我们需要增加自定义的配置文件，需要在bootstrap/app.php中或者其他地方调用<code>$app-&gt;configure(&#39;xxx.php&#39;)</code></p><p>另外，从configure获取路径的方式也会发现，可以将<code>vendor/laravel/lumen-framework/src/../config</code>文件夹拷贝到项目根目录，以方便配置的修改。</p></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2017/07/06/lumen-config/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>