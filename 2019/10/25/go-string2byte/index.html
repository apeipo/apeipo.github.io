<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>优化string和byte转换 | apeipo的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Golang,"><meta name="description" content="源自fastHttp，利用StringHeader和SliceHeader的结构只差一个cap来进行转换，减少转换开销。需要注意的是，这种优化方式，用s2b转换出来的byte数组不能有修改操作（因为string底层的内存不允许修改）。//bs.gopackage bsimport (	&quot;unsafe&quot;	&quot;reflect&quot;)// type StringHeader struct &amp;#123;//"><meta name="keywords" content="Golang"><meta property="og:type" content="article"><meta property="og:title" content="优化string和byte转换"><meta property="og:url" content="http://longlog.me/2019/10/25/go-string2byte/index.html"><meta property="og:site_name" content="apeipo的博客"><meta property="og:description" content="源自fastHttp，利用StringHeader和SliceHeader的结构只差一个cap来进行转换，减少转换开销。需要注意的是，这种优化方式，用s2b转换出来的byte数组不能有修改操作（因为string底层的内存不允许修改）。//bs.gopackage bsimport (	&quot;unsafe&quot;	&quot;reflect&quot;)// type StringHeader struct &amp;#123;//"><meta property="og:locale" content="default"><meta property="og:image" content="http://longlog.me/2019/10/25/go-string2byte/media/15719920984100/15719950374880.jpg"><meta property="og:image" content="http://longlog.me/2019/10/25/go-string2byte/media/15719920984100/15719950735681.jpg"><meta property="og:updated_time" content="2019-10-25T09:54:35.062Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="优化string和byte转换"><meta name="twitter:description" content="源自fastHttp，利用StringHeader和SliceHeader的结构只差一个cap来进行转换，减少转换开销。需要注意的是，这种优化方式，用s2b转换出来的byte数组不能有修改操作（因为string底层的内存不允许修改）。//bs.gopackage bsimport (	&quot;unsafe&quot;	&quot;reflect&quot;)// type StringHeader struct &amp;#123;//"><meta name="twitter:image" content="http://longlog.me/2019/10/25/go-string2byte/media/15719920984100/15719950374880.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#benchmark"><span class="toc-text">benchmark</span></a></li></ol></div><div class="content-post LEFT"><article id="post-go-string2byte" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">优化string和byte转换</h1><div class="article-meta"><span>2019-10-25</span> <span>| </span><span class="article-author">apeipo</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/Golang/">Golang</a></span></div></header><div class="article-content"><p>源自fastHttp，利用StringHeader和SliceHeader的结构只差一个cap来进行转换，减少转换开销。<br>需要注意的是，这种优化方式，用<code>s2b</code>转换出来的byte数组不能有修改操作（因为string底层的内存不允许修改）。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//bs.go</span></span><br><span class="line"><span class="keyword">package</span> bs</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"unsafe"</span></span><br><span class="line">	<span class="string">"reflect"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// type StringHeader struct &#123;</span></span><br><span class="line"><span class="comment">// 	Data uintptr</span></span><br><span class="line"><span class="comment">// 	Len  int</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// type SliceHeader struct &#123;</span></span><br><span class="line"><span class="comment">// 	Data uintptr</span></span><br><span class="line"><span class="comment">// 	Len  int</span></span><br><span class="line"><span class="comment">// 	Cap  int</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b2s</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">   <span class="comment">//byte数组和string的结构只差一个Cap，直接转换截断</span></span><br><span class="line">	<span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// !!!caution: 转出来的byte不能有修改操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">s2b</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	ps := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line"></span><br><span class="line">	b := reflect.SliceHeader&#123;</span><br><span class="line">		Data: ps.Data,</span><br><span class="line">		Len:  ps.Len,</span><br><span class="line">		Cap:  ps.Len, <span class="comment">//增加数组的Cap字段</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//sliceHeader转为实际类型的数组</span></span><br><span class="line">	<span class="keyword">return</span> *(*[]<span class="keyword">byte</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">normal_b2s</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">normal_s2b</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> []<span class="keyword">byte</span>(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h2><p>两种转换bench的结果对比, 由于减少了拷贝，性能比常用的直接转换提高了20倍<br><img src="media/15719920984100/15719950374880.jpg" alt="-w558"></p><p>原始的转换方式，pprof的结果，可以看出来大部分的时间消耗在内存拷贝上<br><img src="media/15719920984100/15719950735681.jpg" alt=""></p><p>附benchmark程序：<br></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> testBytes = []<span class="keyword">byte</span>(<span class="string">"测试字符串bytes"</span>)</span><br><span class="line"><span class="keyword">var</span> testString = <span class="string">"测试字符串bytes"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  go test -v -run="none" -bench=".*B2S"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkB2S</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		b2s(testBytes)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkNormalB2S</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		normal_b2s(testBytes)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkS2B</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		s2b(testString)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkNormalS2B</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		normal_s2b(testString)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2019/10/25/go-string2byte/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>