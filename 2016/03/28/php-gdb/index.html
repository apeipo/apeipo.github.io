<!DOCTYPE html><html><head><meta charset="utf-8"><title>使用gdb查看php进程正在执行的代码 | linxianlong的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="PHP,GDB,"><meta name="description" content="参考链接找出php中可能有问题的代码行使用GDB调试PHP代码，解决PHP代码死循环运行时变量当某个php进程僵死或者长时间占用CPU比较高时，我们需要知道该进程正在执行的代码以确定问题原因。php在解释执行过程中，zend引擎用executor_globals变量保存了执行过程中的各种数据，包括执行函数、文件、代码行等。executor_globals 中的active_op_array 和 c"><meta name="keywords" content="PHP,GDB"><meta property="og:type" content="article"><meta property="og:title" content="使用gdb查看php进程正在执行的代码"><meta property="og:url" content="http://longlog.me/2016/03/28/php-gdb/index.html"><meta property="og:site_name" content="linxianlong的博客"><meta property="og:description" content="参考链接找出php中可能有问题的代码行使用GDB调试PHP代码，解决PHP代码死循环运行时变量当某个php进程僵死或者长时间占用CPU比较高时，我们需要知道该进程正在执行的代码以确定问题原因。php在解释执行过程中，zend引擎用executor_globals变量保存了执行过程中的各种数据，包括执行函数、文件、代码行等。executor_globals 中的active_op_array 和 c"><meta property="og:locale" content="default"><meta property="og:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2016-03-28-14591791052029.jpg"><meta property="og:updated_time" content="2018-08-06T12:12:41.825Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用gdb查看php进程正在执行的代码"><meta name="twitter:description" content="参考链接找出php中可能有问题的代码行使用GDB调试PHP代码，解决PHP代码死循环运行时变量当某个php进程僵死或者长时间占用CPU比较高时，我们需要知道该进程正在执行的代码以确定问题原因。php在解释执行过程中，zend引擎用executor_globals变量保存了执行过程中的各种数据，包括执行函数、文件、代码行等。executor_globals 中的active_op_array 和 c"><meta name="twitter:image" content="http://7xrhmq.com1.z0.glb.clouddn.com/2016-03-28-14591791052029.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE" href="/2018/08/06/2018-Target/">2018</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/2017/03/28/MY-2017/">2017</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/2018/08/06/2018-Target/">2018</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行时变量"><span class="toc-text">运行时变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用gdb查看变量"><span class="toc-text">用gdb查看变量</span></a></li></ol></div><div class="content-post LEFT"><article id="post-php-gdb" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">使用gdb查看php进程正在执行的代码</h1><div class="article-meta"><span>2016-03-28</span> <span>| </span><span class="article-author">Linxianlong</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/PHP/">PHP</a></span></div></header><div class="article-content"><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://www.searchtb.com/2014/04/%E5%BD%93cpu%E9%A3%99%E5%8D%87%E6%97%B6%EF%BC%8C%E6%89%BE%E5%87%BAphp%E4%B8%AD%E5%8F%AF%E8%83%BD%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A1%8C.html" target="_blank" rel="noopener">找出php中可能有问题的代码行</a><br><a href="http://rango.swoole.com/archives/325" target="_blank" rel="noopener">使用GDB调试PHP代码，解决PHP代码死循环</a></p><h2 id="运行时变量"><a href="#运行时变量" class="headerlink" title="运行时变量"></a>运行时变量</h2><p>当某个php进程僵死或者长时间占用CPU比较高时，我们需要知道该进程正在执行的代码以确定问题原因。<br>php在解释执行过程中，zend引擎用<code>executor_globals</code>变量保存了执行过程中的各种数据，包括执行函数、文件、代码行等。<br><code>executor_globals</code> 中的<code>active_op_array</code> 和 <code>current_execute_data</code>变量保存了当前的执行信息。<br>相关定义如下，可以看到<code>active_op_array</code>中有执行时的<code>function_name</code>和<code>filename</code>，<code>current_execute_data</code>中有执行行号。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//active_op_array</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op_array</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Common elements */</span></span><br><span class="line">    zend_uchar type;</span><br><span class="line">    zend_uchar arg_flags[<span class="number">3</span>]; <span class="comment">/* bitset of arg_info.pass_by_reference */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> fn_flags;</span><br><span class="line">    zend_string *function_name;<span class="comment">//function name</span></span><br><span class="line">    zend_class_entry *scope;</span><br><span class="line">    zend_function *prototype;</span><br><span class="line">    <span class="keyword">uint32_t</span> num_args;</span><br><span class="line">    <span class="keyword">uint32_t</span> required_num_args;</span><br><span class="line">    zend_arg_info *arg_info;</span><br><span class="line">    <span class="comment">/* END of common elements */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> *refcount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> this_var;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> last;</span><br><span class="line">    zend_op *opcodes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> last_var;</span><br><span class="line">    <span class="keyword">uint32_t</span> T;</span><br><span class="line">    zend_string **vars;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> last_brk_cont;</span><br><span class="line">    <span class="keyword">int</span> last_try_catch;</span><br><span class="line">    zend_brk_cont_element *brk_cont_array;</span><br><span class="line">    zend_try_catch_element *try_catch_array;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* static variables support */</span></span><br><span class="line">    HashTable *static_variables;</span><br><span class="line"></span><br><span class="line">    zend_string *filename;<span class="comment">//execute file</span></span><br><span class="line">    <span class="keyword">uint32_t</span> line_start;</span><br><span class="line">    <span class="keyword">uint32_t</span> line_end;</span><br><span class="line">    zend_string *doc_comment;</span><br><span class="line">    <span class="keyword">uint32_t</span> early_binding; <span class="comment">/* the linked list of delayed declarations */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> last_literal;</span><br><span class="line">    zval *literals;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>  cache_size;</span><br><span class="line">    <span class="keyword">void</span> **run_time_cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *reserved[ZEND_MAX_RESERVED_RESOURCES];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//current_execute_data</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_execute_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> zend_op       *opline;           <span class="comment">/* executed opline                */</span></span><br><span class="line">    zend_execute_data   *call;             <span class="comment">/* current call                   */</span></span><br><span class="line">    zval                *return_value;</span><br><span class="line">    zend_function       *func;             <span class="comment">/* executed funcrion              */</span></span><br><span class="line">    zval                 This;             <span class="comment">/* this + call_info + num_args    */</span></span><br><span class="line">    zend_class_entry    *called_scope;</span><br><span class="line">    zend_execute_data   *prev_execute_data;</span><br><span class="line">    zend_array          *symbol_table;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_EX_USE_RUN_TIME_CACHE</span></span><br><span class="line">    <span class="keyword">void</span>               **run_time_cache;   <span class="comment">/* cache op_array-&gt;run_time_cache */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_EX_USE_LITERALS</span></span><br><span class="line">    zval                *literals;         <span class="comment">/* cache op_array-&gt;literals       */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//opline</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> &#123;</span></span><br><span class="line">    <span class="keyword">opcode_handler_t</span> handler;</span><br><span class="line">    znode result;</span><br><span class="line">    znode op1;</span><br><span class="line">    znode op2;</span><br><span class="line">    ulong extended_value;</span><br><span class="line">    uint lineno;</span><br><span class="line">    zend_uchar opcode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="用gdb查看变量"><a href="#用gdb查看变量" class="headerlink" title="用gdb查看变量"></a>用gdb查看变量</h2><p>创建一个php文件，用cli方式执行，逻辑就是简单的sleep。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fck</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"hehe"</span>;</span><br><span class="line">       sleep(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">fck();</span><br></pre></td></tr></table></figure><p>执行过程用gdb的-p参数调试进程，<strong>这里得注意，如果php在编译时没有开启debug选项，看到的调试信息中无法获取到执行中的参数</strong></p><blockquote><p>执行gdb后，死循环的进程会变成T的状态，表示正在Trace。这个是独占的，所以不能再使用strace/gdb或者其他ptrace工具对此进程进行调试。另外此进程会中断执行</p></blockquote><p>执行如下图，可以看到，该进程正在执行的是test.php的fck方法<br><img src="http://7xrhmq.com1.z0.glb.clouddn.com/2016-03-28-14591791052029.jpg" alt=""></p><p>另外，php的源码根目录有提供.gdbinit文件，是一个gdb的脚本，封装了上诉过程，在gdb中source该文件后使用zbacktrace可以直接看到当前执行函数、文件名和行数。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> php_src/.gdbinit</span><br><span class="line">zbacktrace</span><br></pre></td></tr></table></figure></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2016/03/28/php-gdb/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>