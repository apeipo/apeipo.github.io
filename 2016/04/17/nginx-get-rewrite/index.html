<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>nginx根据get参数rewrite | apeipo的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Nginx,"><meta name="description" content="先说一种错误的写法location ~ \.php$ &amp;#123;  root           html;  fastcgi_pass   127.0.0.1:9000;  fastcgi_index  index.php;  fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;  include"><meta name="keywords" content="Nginx"><meta property="og:type" content="article"><meta property="og:title" content="nginx根据get参数rewrite"><meta property="og:url" content="http://longlog.me/2016/04/17/nginx-get-rewrite/index.html"><meta property="og:site_name" content="apeipo的博客"><meta property="og:description" content="先说一种错误的写法location ~ \.php$ &amp;#123;  root           html;  fastcgi_pass   127.0.0.1:9000;  fastcgi_index  index.php;  fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;  include"><meta property="og:locale" content="default"><meta property="og:image" content="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2016-04-15-14607165697950.jpg"><meta property="og:updated_time" content="2019-08-29T07:09:16.061Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="nginx根据get参数rewrite"><meta name="twitter:description" content="先说一种错误的写法location ~ \.php$ &amp;#123;  root           html;  fastcgi_pass   127.0.0.1:9000;  fastcgi_index  index.php;  fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;  include"><meta name="twitter:image" content="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2016-04-15-14607165697950.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/styles.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?bec693dc99391bbe29dd7310e3fff81a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div class="post-header LEFT"><div class="toolbox"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE" href="/about/">关于</a></li></ul></div><div class="toolbox tool-vertical" id="tool-vertical"><ul class="list-toolbox list-vertical"><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/">首页</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/categories/">分类</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/tags/">标签</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/link/">友链</a></li><li class="item-toolbox"><a class="CIRCLE VERTICAL" href="/about/">关于</a></li></ul></div><script type="text/javascript">function getStyle(e){return void 0===e.currentStyle?getComputedStyle(e):e.currentStyle}window.onscroll=function(){var e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,t=document.getElementsByClassName("toolbox")[0],l=document.getElementById("tool-vertical"),o=getStyle(l).display,n=document.getElementsByClassName("CIRCLE VERTICAL");if(60<=e&&"none"==o){l.style.display="block",t.style.display="none";for(var s=0;s<n.length;s++)n[s].setAttribute("class","CIRCLE VERTICAL")}if(e<60&&"block"==o)for(t.style.display="block",setTimeout("document.getElementById('tool-vertical').style.display = 'none'",600),s=0;s<n.length;s++)n[s].setAttribute("class",n[s].className+" a-vertical")}</script></div><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#去除原有参数"><span class="toc-text">去除原有参数</span></a></li></ol></div><div class="content-post LEFT"><article id="post-nginx-get-rewrite" class="article article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="post-title">nginx根据get参数rewrite</h1><div class="article-meta"><span>2016-04-17</span> <span>| </span><span class="article-author">apeipo</span> <span>| </span><span class="article-category"><a class="article-category-link" href="/categories/Nginx/">Nginx</a></span></div></header><div class="article-content"><p>先说一种错误的写法</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">  <span class="attribute">root</span>           html;</span><br><span class="line">  <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">  <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">  <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  /<span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">  <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">  <span class="attribute">rewrite</span> /info.php?name=(.*) /result.php?newname=<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上配置，当请求<code>/info.php?name=hehe</code>时，会发现请求没经过rewrite。<strong>这是因为nginx的rewrite指令第一个参数匹配的是请求的URI，是不会匹配<code>QUERY_STRING</code>的</strong>，如上配置会用<code>/info.php?name=(.*)</code>这个正则去匹配<code>/info.php</code>,当然匹配无法成功。<br>正确的方式：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">  <span class="attribute">root</span>           html;</span><br><span class="line">  <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">  <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">  <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  /<span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">  <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$query_string</span> <span class="regexp">~* "name=(.*)")</span> &#123;</span><br><span class="line">      <span class="attribute">set</span> <span class="variable">$name</span> <span class="variable">$1</span>;</span><br><span class="line">      <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$name</span> <span class="literal">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里注意一个问题：<code>set $name $1;</code> 这行不能省略，如果把上边if里的逻辑修改成这种方式，会发现rewrite后get参数李的newname为空，<strong>这是因为此时rewrite语句中的<code>$1</code>并不是if指令里匹配的内容，而是rewrite指令第一个正则匹配的内容</strong>，显然第一个正则(<code>/info.php</code>)没有分组，<code>$1</code>为空。</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$query_string</span> <span class="regexp">~* "name=(.*)")</span> &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，nginx中，可以通过<code>$arg_变量名</code>的方式获得get参数中的字段值，所以也可以写成如下两种形式：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$query_string</span> <span class="regexp">~* "name=(.*)")</span> &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$arg_name</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$arg_name</span> != <span class="string">""</span>) &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$arg_name</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="去除原有参数"><a href="#去除原有参数" class="headerlink" title="去除原有参数"></a>去除原有参数</h2><p>按如上方式进行配置后，请求<code>/info.php?name=hehe</code>时，会<code>rewrite</code>到<code>/result.php?newname=$name</code>。<br>此时，如果在<code>result.php</code>中打印<code>$_GET</code>，<code>$_SERVER</code>的内容：</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123; [<span class="string">"newname"</span>]=&gt; string(<span class="number">4</span>) <span class="string">"hehe"</span> [<span class="string">"name"</span>]=&gt; string(<span class="number">4</span>) <span class="string">"hehe"</span> &#125;</span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="string">"REQUEST_URI"</span>: <span class="string">"/info.php?name=hehe"</span>,</span><br><span class="line"><span class="string">"DOCUMENT_URI"</span>: <span class="string">"/result.php"</span>,</span><br><span class="line"><span class="string">"QUERY_STRING"</span>: <span class="string">"newname=hehe&amp;name=hehe"</span>,</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure><p>可以看到，nginx将原始的<code>query_string</code>追加rewrite后的<code>query_string</code>中了，如果要去除这个参数，可以将<code>$args</code>参数(保存了<code>query_string</code>)置为空：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$query_string</span> <span class="regexp">~* "name=(.*)")</span> &#123;</span><br><span class="line">       <span class="attribute">set</span> <span class="variable">$args</span> <span class="string">""</span>; </span><br><span class="line">    <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$arg_name</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者可以在rewrite指令第二个参数最后加一个<strong>?</strong>号：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$query_string</span> <span class="regexp">~* "name=(.*)")</span> &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> /info.php /result.php?newname=<span class="variable">$arg_name</span>? <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时再打印GET参数会发现<code>QUERY_String</code>中不带着name参数了，nginx官网的描述：<br><img src="https://longlog-1300108443.cos.ap-beijing.myqcloud.com/before2019/2016-04-15-14607165697950.jpg" alt=""></p></div></article><section class="disqus-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><script type="text/javascript">!function(){var t=document.getElementsByTagName("article")[0];if(null!=t){imgs=t.getElementsByTagName("img");for(var e=0;e<imgs.length;e++)img=imgs[e],width=parseInt(img.getAttribute("alt").replace("-w","")),0<width&&img.setAttribute("style","width:"+width+"px")}}()</script><script>var disqus_shortname="apeipo",disqus_url="http://longlog.me/2016/04/17/nginx-get-rewrite/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body>